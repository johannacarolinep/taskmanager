@model TaskManager.ViewModels.TasklistDetailViewModel

@{
    ViewData["Title"] = "Tasklist Details";
}

<h2>@Model.Title</h2>

<div>
    <h3>Tasklist Information</h3>
    <p>@Model.Description</p>
    <p><strong>Created At:</strong> @Model.CreatedAt.ToString("g")</p>
    <p><strong>Created By:</strong> @Model.CreatedByUsername</p>
    <p><strong>Your Role:</strong> @Model.UserRole</p>
</div>

<hr />

<div>
    <h3>Contributors</h3>
    <ul>
        @foreach (var contributor in Model.Contributors)
        {
            <li>
                <img src="@contributor.Image" alt="@contributor.Username" style="width: 30px; height: 30px; border-radius: 50%;" />
                <strong>@contributor.Username</strong> - Role: @contributor.Role
            </li>
        }
    </ul>
</div>

<hr />

@{
    var errorMessage = TempData["ErrorMessage"] as string;
}

@if (!string.IsNullOrEmpty(errorMessage)) {
    <div class="alert alert-danger">
        @errorMessage
    </div>
}

<div>
    <h3>Tasks</h3>

    @if (Model.UserRole == "Owner" || Model.UserRole == "Admin") {
        <p>
            <a asp-controller="Task" asp-action="Create" asp-route-listId="@Model.TasklistId">Create New Task</a>
        </p>   
    }

    <!-- Search Form -->
    <form asp-action="Tasklist" method="get" asp-route-listId="@Model.TasklistId">
        <input type="text" name="searchString" value="@ViewBag.SearchString" placeholder="Search by title..." />
        <button type="submit">Search</button>
    </form>

    <!-- Filter form -->
    <form method="get" asp-controller="Tasklist" asp-action="Tasklist">
        <input type="hidden" name="listId" value="@Model.TasklistId" />
        <div>
            <h4>Filter by Priority:</h4>
            <label>
                <input type="checkbox" name="selectedPriority" value="1" 
                    @(ViewBag.SelectedPriority != null && ViewBag.SelectedPriority.Contains(1) ? "checked" : "") /> 1
            </label>
            <label>
                <input type="checkbox" name="selectedPriority" value="2" 
                    @(ViewBag.SelectedPriority != null && ViewBag.SelectedPriority.Contains(2) ? "checked" : "") /> 2
            </label>
            <label>
                <input type="checkbox" name="selectedPriority" value="3" 
                    @(ViewBag.SelectedPriority != null && ViewBag.SelectedPriority.Contains(3) ? "checked" : "") /> 3
            </label>
        </div>

        <div>
            <h4>Filter by Status:</h4>
            <label>
                <input type="checkbox" name="selectedStatus" value="NotStarted" 
                    @(ViewBag.SelectedStatus != null && ViewBag.SelectedStatus.Contains("NotStarted") ? "checked" : "") /> Not Started
            </label>
            <label>
                <input type="checkbox" name="selectedStatus" value="InProgress" 
                    @(ViewBag.SelectedStatus != null && ViewBag.SelectedStatus.Contains("InProgress") ? "checked" : "") /> In Progress
            </label>
            <label>
                <input type="checkbox" name="selectedStatus" value="Done" 
                    @(ViewBag.SelectedStatus != null && ViewBag.SelectedStatus.Contains("Done") ? "checked" : "") /> Done
            </label>
        </div>

        <button type="submit">Filter</button>
    </form>

    <!-- Sorting Links -->
    <div>
        <a asp-action="Tasklist" asp-route-listId="@Model.TasklistId" asp-route-sortOrder="description" asp-route-searchString="@ViewBag.SearchString" asp-route-filter="@ViewBag.Filter">Sort by description</a> |
        <a asp-action="Tasklist" asp-route-listId="@Model.TasklistId" asp-route-sortOrder="deadline" asp-route-searchString="@ViewBag.SearchString" asp-route-filter="@ViewBag.Filter">Sort by deadline</a>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>Task Description</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Deadline</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Tasks.Count == 0)
            {
                <tr>
                    <td colspan="5">No tasks available for this tasklist.</td>
                </tr>
            }
            else
            {
                foreach (var task in Model.Tasks)
                {
                    <tr>
                        <td>@task.Description</td>
                        <td>@task.Priority</td>
                        <td>@Html.DisplayFor(model => task.Status)</td>
                        <td>@task.Deadline?.ToString("g")</td>
                        <td>@task.CreatedAt.ToString("g")</td>
                        <td>
                            @if (Model.UserRole == "Owner" || Model.UserRole == "Admin") {
                                <a asp-controller="Task" asp-action="Edit" asp-route-TaskId="@task.Id">Edit</a>
                                <a asp-controller="Task" asp-action="Delete" asp-route-TaskId="@task.Id">Delete</a>
                            }
                            @if (task.Status == TaskManager.Models.TaskStatus.NotStarted) {
                                <form asp-controller="Task" asp-action="Progress" method="post" style="display: inline;">
                                    <input type="hidden" name="taskId" value="@task.Id" />
                                    <button type="submit" class="btn btn-primary">Mark as in progress</button>
                                </form>
                            }
                            @if (task.Status == TaskManager.Models.TaskStatus.NotStarted || task.Status == TaskManager.Models.TaskStatus.InProgress) {
                                <form asp-controller="Task" asp-action="Complete" method="post" style="display: inline;">
                                    <input type="hidden" name="taskId" value="@task.Id" />
                                    <button type="submit" class="btn btn-primary">Mark as complete</button>
                                </form>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>
